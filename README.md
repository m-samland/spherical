# spherical: VLT/SPHERE Observation Database and IFS Data Analysis Pipeline

[![Python Version](https://img.shields.io/badge/Python-3.11%20%7C%203.12%20%7C%203.13-brightgreen.svg)](https://github.com/m-samland/spherical)
[![License](https://img.shields.io/badge/License-BSD--3-blue.svg)](https://opensource.org/licenses/BSD-3-Clause)
[![CI](https://github.com/m-samland/spherical/actions/workflows/ci.yml/badge.svg)](https://github.com/m-samland/spherical/actions/workflows/ci.yml)

**spherical** provides comprehensive tools for exploring and analyzing data from the ESO VLT/SPHERE instrument, specifically tailored for high-contrast imaging observations with the IRDIS and IFS instruments.

---

## Overview

**spherical** features a specially curated observation database, uniquely built by analyzing headers from all available SPHERE data in the ESO archive. Unlike the official ESO archive, this database systematically discovers every SPHERE observation sequence and provides detailed summary statistics such as observing modes, target properties, integration times, and observing conditions.

Users can easily explore and filter the database to identify observation sequences of interest and seamlessly feed these sequences into an end-to-end data analysis workflow for SPHERE IFS. This pipeline automates data discovery, downloading, calibration, planet detection, and spectral characterization. For the IRDIS instrument, data discovery and downloading of dual-band imaging (DBI)observations and polarimetric imaging observations is supported.

---

## Key Features

- **Comprehensive Database**: Automatically generated by cross-referencing all available SPHERE data headers with the Gaia catalog to ensure accuracy and completeness.
- **Data Exploration**: Quickly identify SPHERE observations based on custom filters (e.g., star properties, observation conditions).
- **End-to-End IFS Pipeline**: Fully automated pipeline covering:
  - Data download from the ESO archive
  - Spectral cube extraction using the adapted CHARIS pipeline ([Samland et al. 2022](https://ui.adsabs.harvard.edu/abs/2022A%26A...668A..84S/abstract))
  - Astrometric and photometric calibration ([A. Vigan's SPHERE tools](https://github.com/avigan/SPHERE))
  - Post-processing with the TRAP algorithm ([Samland et al. 2021](https://ui.adsabs.harvard.edu/abs/2017AJ....154....7G/abstract))
  - Automatic detection and extraction of exoplanet contrast spectra

---

## Installation

The package requires Python 3.11 or higher. We strongly recommend creating a dedicated environment, for instance using [Miniconda](https://conda.io/miniconda):

```bash
conda create -n spherical_env python=3.12
conda activate spherical_env
```

### Base installation (database exploration only)

```bash
pip install git+https://github.com/m-samland/spherical.git
```

> **Note:**  
> The SPHERE database tables (`table_of_IFS_observations`, `table_of_files`) must be downloaded separately from [Zenodo](https://doi.org/10.5281/zenodo.15147730) (DOI: `10.5281/zenodo.15147730`). These tables are **not included in this repository**.

### Full pipeline installation (including data reduction)

To install the full data reduction pipeline for SPHERE IFS (only Python <3.13 supported due to Ray dependency):

```bash
pip install ".[pipeline]"
```

To run the example notebook:

```bash
pip install ".[notebook]"
```

---

## Quick Start Guide

1. **Download Database Tables**  
   Obtain the necessary database tables from [Zenodo](https://doi.org/10.5281/zenodo.15147731).

2. **Explore Observations**  
   Launch the provided Jupyter notebook `explore_database.ipynb` to browse and filter available observations.

3. **Run Data Analysis Pipeline** (currently SPHERE IFS only)  
   Adapt and use the provided template script `ifs_reduction_template.py` to automate the full workflow:
   ```bash
   python ifs_reduction_template.py
   ```

If you want to re-generate or update the database tables with newer data, use the provided script:

```bash
python generate_database.py
```

---

## Documentation and Examples

Currently, the documentation focuses on practical usage examples:

- `generate_database.py`: Generate or update the SPHERE observations database.
- `explore_database.ipynb`: Explore and filter the observation database interactively.
- `ifs_reduction_template.py`: Automate data download, reduction, and planet characterization for selected IFS observations.

Detailed documentation will be expanded in future updates.

---

## Citation and Attribution

If **spherical** supports your research, please cite the relevant papers below:

- **IFS pipeline:** [Samland et al. (2022)](https://ui.adsabs.harvard.edu/abs/2022A%26A...668A..84S/abstract)
- **TRAP post-processing:** [Samland et al. (2021)](https://ui.adsabs.harvard.edu/abs/2017AJ....154....7G/abstract)
- **Species package (spectral calibration)**: [Stolker et al. (2020)](https://ui.adsabs.harvard.edu/abs/2020A%26A...635A.182S/abstract)

Also, see research papers that have utilized **spherical**:

- [Franson et al. (2023)](https://ui.adsabs.harvard.edu/abs/2023AJ....165...39F/abstract)

---

## Contributing

We warmly welcome contributions to **spherical**! Here's how to get started:

### Setup for Developers

Clone the repository and install it locally for development with tests:

```bash
git clone https://github.com/m-samland/spherical.git
cd spherical
pip install -e ".[test]"
```

### Contributing Guidelines

- Please use **feature branches or forks** for developing new features or bug fixes.
- **Issue and Pull Request templates** are providedâ€”please use them.
- Always run the code linting tool (`ruff`) before submitting a Pull Request:

```bash
ruff check .
```

New to GitHub or contributing to open-source? No problem!  
Feel free to [open an issue](https://github.com/m-samland/spherical/issues) for questions or email [@m-samland](https://github.com/m-samland).

---

## License

This project is licensed under the [BSD-3-Clause License](https://opensource.org/licenses/BSD-3-Clause).

---